{% extends "base.html" %}

{% block title %}Exam List{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4 mt-5">
    <h2 class="fw-bold mb-0">My Exams</h2>
</div>

<!-- Search Bar -->
<div class="card shadow-sm mb-3">
    <div class="card-body">
        <input id="searchInput" type="text" class="form-control" placeholder="Search exam by ID or title...">
    </div>
</div>

<!-- Exam Table -->
<div class="card shadow-sm">
    <div class="card-body p-0">

        <table id="examTable" class="table table-hover table-borderless align-middle mb-0">
            <thead style="background: #1b263b; color: #fff;">
                <tr>
                    <th onclick="sortTable(0)" class="sortable">ID <span class="sort-icon"></span></th>
                    <th onclick="sortTable(1)" class="sortable">Title <span class="sort-icon"></span></th>
                    <th onclick="sortTable(2)" class="sortable">Questions <span class="sort-icon"></span></th>
                    <th onclick="sortTable(3)" class="sortable">Start <span class="sort-icon"></span></th>
                    <th onclick="sortTable(4)" class="sortable">End <span class="sort-icon"></span></th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for exam in exams %}
                <tr data-id="{{ exam.exam_id|lower }}" data-title="{{ exam.title|lower }}">

                    <td class="fw-bold text-primary">
                        {{ exam.exam_id }}
                    </td>

                    <td class="fw-semibold">{{ exam.title }}</td>

                    <td>
                        <span class="badge bg-secondary">
                            {{ exam.questions.count }} Question{% if exam.questions.count != 1 %}s{% endif %}
                        </span>
                    </td>

                    <td>{{ exam.start_time|date:"Y-m-d H:i" }}</td>
                    <td>{{ exam.end_time|date:"Y-m-d H:i" }}</td>

                    <td class="text-center">
                        <!-- View/Edit -->
                        <a href="/instructor/exams/{{ exam.exam_id }}/" class="btn btn-sm btn-outline-primary me-1">
                            <i class="bi bi-pencil-fill"></i>
                        </a>

                        <!-- Delete -->
                        <a href="/instructor/exams/{{ exam.exam_id }}/delete/" class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('Delete this exam?');">
                            <i class="bi bi-trash-fill"></i>
                        </a>
                        <a href="/instructor/exams/{{ exam.exam_id }}/submissions/" class="btn btn-sm btn-outline-success ms-1">
                            <i class="bi bi-people-fill"></i> Submissions
                        </a>
                    </td>

                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">
                        No exams created yet.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
</div>

<!-- Search Script -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("searchInput");
        const rows = document.querySelectorAll("#examTable tbody tr");

        searchInput.addEventListener("input", function () {
            const query = this.value.toLowerCase();

            rows.forEach(row => {
                const matches =
                    row.dataset.id.includes(query) ||
                    row.dataset.title.includes(query);

                row.style.display = matches ? "" : "none";
            });
        });
    });

    let sortDirections = {};

    function sortTable(colIndex) {
        const table = document.getElementById("examTable");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        sortDirections[colIndex] = !sortDirections[colIndex];
        const ascending = sortDirections[colIndex];

        rows.sort((a, b) => {
            let valA = a.children[colIndex].innerText.trim();
            let valB = b.children[colIndex].innerText.trim();

            if (colIndex === 3 || colIndex === 4) {
                valA = new Date(valA).getTime();
                valB = new Date(valB).getTime();
            }

            if (colIndex === 2) {
                valA = parseInt(valA);
                valB = parseInt(valB);
            }

            if (colIndex === 0) {
                valA = parseInt(valA.split("-")[1]);
                valB = parseInt(valB.split("-")[1]);
            }

            if (valA < valB) return ascending ? -1 : 1;
            if (valA > valB) return ascending ? 1 : -1;
            return 0;
        });

        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));

        updateSortIcons(colIndex, ascending);
    }

    function updateSortIcons(colIndex, ascending) {
        const icons = document.querySelectorAll(".sort-icon");
        icons.forEach(icon => icon.innerHTML = ""); // reset

        const targetIcon = icons[colIndex];
        targetIcon.innerHTML = ascending ? "▲" : "▼";
    }
</script>

<style>
    .sortable {
        cursor: pointer;
        user-select: none;
    }

    .sortable:hover {
        background-color: #ddd !important;
    }

    .sort-icon {
        margin-left: 6px;
        font-size: 0.75rem;
        opacity: 0.8;
    }
</style>

{% endblock %}