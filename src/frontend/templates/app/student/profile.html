{% extends "base.html" %}
{% block title %}My Profile{% endblock %}

{% block content %}
<div class="container mt-0">
    {# show flash messages here #}
    {% if messages %}
        <div class="mb-0">
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h2 class="fw-bold mb-1">Student Profile</h2>
            <p class="text-muted mb-0">
                ID: <strong>{{ student.student_ID }}</strong> â€¢ Role: Student
            </p>
            <p class="text-muted mb-0">
                Joined at: {{ student.created_at|date:"Y-m-d H:i" }}
            </p>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" id="studentProfileForm">
                {% csrf_token %}

                <div class="mb-3">
                    <label class="form-label">Full Name</label>
                    <input type="text" name="full_name" class="form-control"
                           value="{{ student.full_name }}" disabled>
                </div>

                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" name="student_email" class="form-control"
                           value="{{ student.student_email }}" disabled>
                </div>

                <div class="mb-3">
                    <label class="form-label">Matric Number</label>
                    <input type="text" name="matric_number" class="form-control"
                           value="{{ student.matric_number }}" disabled>
                </div>

                <div class="mb-3">
                    <label class="form-label">Contact Number</label>
                    <input type="text" name="contact_number" class="form-control"
                           value="{{ student.contact_number }}" disabled>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="button" id="editStudentBtn" class="btn btn-outline-primary me-2">
                        Edit Profile
                    </button>
                    <button type="submit" id="saveStudentBtn" class="btn btn-primary d-none">
                        Save Changes
                    </button>
                    <button type="button" id="cancelStudentBtn" class="btn btn-secondary d-none">
                        Cancel
                    </button>
                </div>
                <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card shadow-sm"><div class="card-body">
                    <div class="text-muted small">Total Attempts</div>
                    <div class="h4 mb-0">{{ student_stats.total_attempts }}</div>
                    </div></div>
                </div>

                <div class="col-md-3">
                    <div class="card shadow-sm"><div class="card-body">
                    <div class="text-muted small">Submitted</div>
                    <div class="h4 mb-0">{{ student_stats.submitted_count }}</div>
                    </div></div>
                </div>

                <div class="col-md-3">
                    <div class="card shadow-sm"><div class="card-body">
                    <div class="text-muted small">Average Score</div>
                    <div class="h4 mb-0">{{ student_stats.avg_score|default:"-"|floatformat:1 }}</div>
                    </div></div>
                </div>

                <div class="col-md-3">
                    <div class="card shadow-sm"><div class="card-body">
                    <div class="text-muted small">Best Score</div>
                    <div class="h4 mb-0">{{ student_stats.best_score|default:"-"|floatformat:1 }}</div>
                    </div></div>
                </div>
                </div>

                <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Recent Exam Activity</h5>

                    {% if recent_attempts %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                            <th>Exam</th><th>Title</th><th>Status</th><th>Score</th><th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in recent_attempts %}
                            <tr>
                                <td>{{ a.exam.exam_id }}</td>
                                <td>{{ a.exam.title }}</td>
                                <td>{% if a.submitted_at %}Submitted{% else %}In Progress{% endif %}</td>
                                <td>{{ a.score|default:"-" }}</td>
                                <td>{{ a.submitted_at|default:a.started_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No exam activity yet.</p>
                    {% endif %}
                </div>
                </div>

            </form>
        </div>
    </div>
    

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("studentProfileForm");
    if (!form) return;

    const inputs = form.querySelectorAll("input");
    const editBtn = document.getElementById("editStudentBtn");
    const saveBtn = document.getElementById("saveStudentBtn");
    const cancelBtn = document.getElementById("cancelStudentBtn");

    // store original values so we can restore on cancel
    const originalValues = {};
    inputs.forEach(input => {
        originalValues[input.name] = input.value;
    });

    editBtn.addEventListener("click", function () {
        inputs.forEach(i => i.disabled = false);
        editBtn.classList.add("d-none");
        saveBtn.classList.remove("d-none");
        cancelBtn.classList.remove("d-none");
    });

    cancelBtn.addEventListener("click", function () {
        inputs.forEach(i => {
            i.value = originalValues[i.name];
            i.disabled = true;
        });
        saveBtn.classList.add("d-none");
        cancelBtn.classList.add("d-none");
        editBtn.classList.remove("d-none");
    });
});
</script>
{% endblock %}
